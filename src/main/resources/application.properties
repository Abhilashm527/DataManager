spring.application.name=Dataloaders


# Jackson configuration to exclude null values
spring.jackson.default-property-inclusion=NON_NULL


#Resource SQL Queries
Resource.get=SELECT * FROM dataloaders.resources
Resource.create=INSERT INTO dataloaders.resources (resource_id, resource_type, resource_name, description, configuration, status, last_tested_at, is_active, display_order, created_by, created_at, item_id) VALUES (?, ?, ?, ?, ?::jsonb, ?, ?, ?, ?, ?, ?, ?);
Resource.getById=${Resource.get} WHERE resource_id = ? AND deleted_at IS NULL
Resource.getAll=${Resource.get} WHERE deleted_at IS NULL ORDER BY display_order ASC
Resource.getAllSortedByOrder=${Resource.get} WHERE deleted_at IS NULL ORDER BY display_order ASC
Resource.getByResourceType=${Resource.get} WHERE resource_type = ? AND deleted_at IS NULL ORDER BY display_order ASC
Resource.getMaxSerial=SELECT COALESCE(MAX(CAST(SUBSTRING(resource_id, 5) AS BIGINT)), 0) as max_serial FROM dataloaders.resources WHERE resource_id LIKE 'RES-%' AND deleted_at IS NULL
Resource.getMaxDisplayOrder=SELECT COALESCE(MAX(display_order), 0) FROM dataloaders.resources WHERE deleted_at IS NULL
Resource.updateById=UPDATE dataloaders.resources SET resource_name=?, description=?, configuration=?::jsonb, status=?, is_active=?, display_order=?, updated_by=?, updated_at=? WHERE resource_id = ? AND deleted_at IS NULL;
Resource.updateDisplayOrder=UPDATE dataloaders.resources SET display_order=?, updated_by=?, updated_at=? WHERE resource_id = ? AND deleted_at IS NULL;
Resource.updateStatus=UPDATE dataloaders.resources SET status=?, last_tested_at=?, updated_by=?, updated_at=? WHERE resource_id = ? AND deleted_at IS NULL;
Resource.deleteById=UPDATE dataloaders.resources SET updated_by=?, updated_at=?, deleted_at=? WHERE resource_id = ? AND deleted_at IS NULL;
Resource.getByItemId=${Resource.get} WHERE item_id = ? AND deleted_at IS NULL

#ResourceType SQL Queries
ResourceType.get=SELECT * FROM dataloaders.resource_types
ResourceType.create=INSERT INTO dataloaders.resource_types (resource_type_id, type_name, description, config_fields, display_order, is_active, created_by, created_at) VALUES (?, ?, ?, ?::jsonb, ?, ?, ?, ?);
ResourceType.getById=${ResourceType.get} WHERE resource_type_id = ? AND deleted_at IS NULL
ResourceType.getByTypeName=${ResourceType.get} WHERE type_name = ? AND deleted_at IS NULL
ResourceType.getAll=${ResourceType.get} WHERE deleted_at IS NULL ORDER BY display_order ASC
ResourceType.getAllActive=${ResourceType.get} WHERE is_active = true AND deleted_at IS NULL ORDER BY display_order ASC
ResourceType.getAllSortedByOrder=${ResourceType.get} WHERE deleted_at IS NULL ORDER BY display_order ASC
ResourceType.getMaxSerial=SELECT COALESCE(MAX(CAST(SUBSTRING(resource_type_id, 4) AS BIGINT)), 0) as max_serial FROM dataloaders.resource_types WHERE resource_type_id LIKE 'RT-%' AND deleted_at IS NULL
ResourceType.getMaxDisplayOrder=SELECT COALESCE(MAX(display_order), 0) FROM dataloaders.resource_types WHERE deleted_at IS NULL
ResourceType.updateById=UPDATE dataloaders.resource_types SET type_name=?, description=?, config_fields=?::jsonb, display_order=?, is_active=?, updated_by=?, updated_at=? WHERE resource_type_id = ? AND deleted_at IS NULL;
ResourceType.updateDisplayOrder=UPDATE dataloaders.resource_types SET display_order=?, updated_by=?, updated_at=? WHERE resource_type_id = ? AND deleted_at IS NULL;
ResourceType.updateStatus=UPDATE dataloaders.resource_types SET is_active=?, updated_by=?, updated_at=? WHERE resource_type_id = ? AND deleted_at IS NULL;
ResourceType.deleteById=UPDATE dataloaders.resource_types SET updated_by=?, updated_at=?, deleted_at=? WHERE resource_type_id = ? AND deleted_at IS NULL;

#Items
Item.create=INSERT INTO dataloaders.items (id, parent_id, parent_folder_id, name, type, item_type, path, item_reference, deletable, active, root, version, created_by, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
Item.getById=SELECT * FROM dataloaders.items WHERE id = ? AND deleted_at IS NULL
Item.getRootFolders=SELECT * FROM dataloaders.items WHERE root = TRUE AND deleted_at IS NULL
Item.getChildrenByParentId=SELECT * FROM dataloaders.items WHERE parent_id = ? AND deleted_at IS NULL
Item.findByReferencedId=SELECT * FROM dataloaders.items WHERE item_reference = ? AND deleted_at IS NULL
Item.UpdateById=UPDATE dataloaders.items SET name = ?, parent_id = ?, root = ?, updated_by = ?, updated_at = ? WHERE id = ? AND deleted_at IS NULL
Item.DeleteById=UPDATE dataloaders.items SET updated_by = ?, updated_at = ?, deleted_at = ? WHERE id = ? AND deleted_at IS NULL
Item.DeleteByReferenceId=UPDATE dataloaders.items SET updated_by = ?, updated_at = ?, deleted_at = ? WHERE item_reference = ? AND deleted_at IS NULL


#Mappings SQL Queries
Mappings.get=SELECT * FROM dataloaders.mappings
Mappings.create=INSERT INTO dataloaders.mappings (mapping_id, mapping_name, mappings, is_active, item_id, created_by, created_at) VALUES (?, ?, ?::jsonb, ?, ?, ?, ?);
Mappings.getById=${Mappings.get} WHERE mapping_id = ? AND deleted_at IS NULL
Mappings.getAll=${Mappings.get} WHERE deleted_at IS NULL ORDER BY created_at DESC
Mappings.getByItemId=${Mappings.get} WHERE item_id = ? AND deleted_at IS NULL ORDER BY created_at DESC
Mappings.getActiveOnly=${Mappings.get} WHERE is_active = true AND deleted_at IS NULL ORDER BY created_at DESC
Mappings.getByItemIdAndStatus=${Mappings.get} WHERE item_id = ? AND is_active = ? AND deleted_at IS NULL ORDER BY created_at DESC
Mappings.updateById=UPDATE dataloaders.mappings SET mapping_name=?, mappings=?::jsonb, is_active=?, updated_by=?, updated_at=? WHERE mapping_id = ? AND deleted_at IS NULL;
Mappings.deleteById=UPDATE dataloaders.mappings SET updated_by=?, updated_at=?, deleted_at=? WHERE mapping_id = ? AND deleted_at IS NULL;
Mappings.countByItemId=SELECT COUNT(*) FROM dataloaders.mappings WHERE item_id = ? AND deleted_at IS NULL

#JobConfig SQL Queries
JobConfig.get=SELECT * FROM dataloaders.job_configs
JobConfig.create=INSERT INTO dataloaders.job_configs (job_id, parent_job_id, job_name, job_description, impacts, job_severity, chunk_size, mapping_id, source_config, target_config, scheduled, schedule, published, published_version, deployed_version, deployed, status, is_active, created_by, created_at, updated_by, updated_at, deleted_at, item_id, drafted) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?::jsonb, ?::jsonb, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
JobConfig.getById=${JobConfig.get} WHERE job_id = ? AND deleted_at IS NULL
JobConfig.getLatestByParentId=${JobConfig.get} WHERE parent_job_id = ? AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1
JobConfig.getAll=${JobConfig.get} WHERE deleted_at IS NULL ORDER BY created_at DESC
JobConfig.getByParentId=${JobConfig.get} WHERE parent_job_id = ? and deleted_at IS NULL ORDER BY created_at DESC
JobConfig.getByItemId=${JobConfig.get} WHERE item_id = ? AND deleted_at IS NULL ORDER BY created_at DESC
JobConfig.getActiveOnly=${JobConfig.get} WHERE is_active = true AND deleted_at IS NULL ORDER BY created_at DESC
JobConfig.updateById=UPDATE dataloaders.job_configs SET parent_job_id=?, job_name=?, job_description=?, impacts=?, job_severity=?, chunk_size=?, mapping_id=?, source_config=?::jsonb, target_config=?::jsonb, scheduled=?, schedule=?, published=?, published_version=?, deployed_version=?, deployed=?, status=?, is_active=?, updated_by=?, updated_at=? WHERE job_id = ? AND deleted_at IS NULL;
JobConfig.deleteById=UPDATE dataloaders.job_configs SET updated_by=?, updated_at=?, deleted_at=? WHERE job_id = ? AND deleted_at IS NULL;
JobConfig.getPublishedVersion=SELECT * FROM dataloaders.job_configs WHERE parent_job_id = ? AND published_version = ? AND status = 'PUBLISHED' AND deleted_at IS NULL;
JobConfig.getLatestPublishedVersion=SELECT published_version FROM dataloaders.job_configs WHERE parent_job_id = ? AND status != 'DRAFT' AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1;
JobConfig.getLatestDeployedVersion=SELECT deployed_version FROM dataloaders.job_configs WHERE parent_job_id = ? AND status = 'DEPLOYED' AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1;
JobConfig.updateParentJobId=UPDATE dataloaders.job_configs SET parent_job_id=?, updated_by=?, updated_at=? WHERE job_id = ? AND deleted_at IS NULL;
JobConfig.deleteByParentId=UPDATE dataloaders.job_configs SET updated_by=?, updated_at=?, deleted_at=? WHERE parent_job_id = ? AND deleted_at IS NULL;


#JobConfigReference SQL Queries
JobConfigReference.create=INSERT INTO dataloaders.job_config_references (id, item_id, job_id, created_by, created_at) VALUES (?, ?, ?, ?, ?);
JobConfigReference.getById=SELECT * FROM dataloaders.job_config_references WHERE id = ? AND deleted_at IS NULL;
JobConfigReference.getByItemId=SELECT * FROM dataloaders.job_config_references WHERE item_id = ? AND deleted_at IS NULL;
JobConfigReference.getByJobId=SELECT * FROM dataloaders.job_config_references WHERE job_id = ? AND deleted_at IS NULL;
JobConfigReference.deleteById=UPDATE dataloaders.job_config_references SET updated_by=?, updated_at=?, deleted_at=? WHERE id = ? AND deleted_at IS NULL;
JobConfigReference.getAll=SELECT * FROM dataloaders.job_config_references AND deleted_at IS NULL;

#ActivityLog SQL Queries
ActivityLog.create=INSERT INTO dataloaders.activity_logs (id, activity_type, entity_type, entity_id, entity_name, action, description, user_id, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?);
ActivityLog.getById=SELECT * FROM dataloaders.activity_logs WHERE id = ?
ActivityLog.getAll=SELECT * FROM dataloaders.activity_logs ORDER BY created_at DESC
ActivityLog.getRecent=SELECT * FROM dataloaders.activity_logs ORDER BY created_at DESC LIMIT ?

#Deploy SQL Queries
Deploy.get=SELECT * FROM dataloaders.deploys
Deploy.create=INSERT INTO dataloaders.deploys (deploy_id, deploy_name, parent_id, job_id, manual_run, schedule, schedule_expression, scheduler_id, scheduler_name, active, created_by, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
Deploy.getById=${Deploy.get} WHERE deploy_id = ? AND deleted_at IS NULL
Deploy.getAll=${Deploy.get} WHERE deleted_at IS NULL ORDER BY created_at DESC
Deploy.getByJobId=${Deploy.get} WHERE job_id = ? AND deleted_at IS NULL ORDER BY created_at DESC
Deploy.getActiveByJobId=${Deploy.get} WHERE job_id = ? AND active = true AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1
Deploy.updateStatus=UPDATE dataloaders.deploys SET active=?, updated_by=?, updated_at=? WHERE deploy_id = ? AND deleted_at IS NULL;
Deploy.deleteById=UPDATE dataloaders.deploys SET updated_by=?, updated_at=?, deleted_at=? WHERE deploy_id = ? AND deleted_at IS NULL;
Deploy.getByAppId=select * from dataloaders.deploys d where job_id in (select job_id from dataloaders.job_configs jc where item_id in (select id from dataloaders.items i where parent_id  = ? and deleted_at is null) and deleted_at  is null and deployed ) AND deleted_at IS NULL;
Deploy.getByScheduleId=${Deploy.get} WHERE scheduler_id = ? AND deleted_at IS NULL
Deploy.deleteByScheduleId=UPDATE dataloaders.deploys SET updated_at=?, deleted_at=? WHERE scheduler_id = ? AND deleted_at IS NULL;

#DataTable
Datatable.create=INSERT INTO dataloaders.datatable (id, datatable_id, application_id, created_by, created_at) VALUES (?, ?, ?, ?, ?);
Datatable.get=SELECT * FROM dataloaders.datatable
Datatable.getByApplicationId=${Datatable.get} where application_id=? and deleted_at IS NULL;
Datatable.DeleteByDatatableId=UPDATE dataloaders.datatable SET updated_by=?, updated_at=?, deleted_at=? WHERE datatable_id = ? AND deleted_at IS NULL;