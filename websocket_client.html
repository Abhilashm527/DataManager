<!DOCTYPE html>
<html>
<head>
    <title>Dataloaders Activity Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .activity { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .activity-header { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>üîÑ Dataloaders Activity Monitor</h1>
    
    <div id="status" class="status disconnected">Connecting to WebSocket...</div>
    
    <button onclick="testActivity()">üß™ Test Activity</button>
    <button onclick="clearActivities()">üóëÔ∏è Clear</button>
    
    <h2>üìã Recent Activities</h2>
    <div id="activities"></div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <script>
        let stompClient = null;
        
        function connect() {
            const socket = new SockJS('http://localhost:8083/ws/activity');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                document.getElementById('status').innerHTML = '‚úÖ Connected to WebSocket';
                document.getElementById('status').className = 'status connected';
                console.log('Connected: ' + frame);
                
                stompClient.subscribe('/topic/activities', function(message) {
                    const activity = JSON.parse(message.body);
                    console.log('üîî Activity received:', activity);
                    displayActivity(activity);
                });
            }, function(error) {
                document.getElementById('status').innerHTML = '‚ùå Connection failed: ' + error;
                document.getElementById('status').className = 'status disconnected';
                console.error('WebSocket connection error:', error);
            });
        }
        
        function displayActivity(activity) {
            const activityDiv = document.createElement('div');
            activityDiv.className = 'activity';
            
            const timestamp = new Date(activity.createdAt * 1000).toLocaleString();
            
            activityDiv.innerHTML = `
                <div class="activity-header">${getActivityIcon(activity.action)} ${activity.action}</div>
                <div><strong>Type:</strong> ${activity.activityType}</div>
                <div><strong>Entity:</strong> ${activity.entityType} - ${activity.entityName}</div>
                <div><strong>Description:</strong> ${activity.description}</div>
                <div><strong>User:</strong> ${activity.userId}</div>
                <div><strong>Time:</strong> ${timestamp}</div>
                <div><strong>ID:</strong> ${activity.id}</div>
            `;
            
            document.getElementById('activities').prepend(activityDiv);
        }
        
        function getActivityIcon(action) {
            switch(action) {
                case 'DRAFT_CREATED': return 'üìù';
                case 'PUBLISHED': return 'üöÄ';
                case 'DEPLOYED': return '‚ö°';
                case 'CREATED': return '‚ú®';
                case 'UPDATED': return 'üîÑ';
                case 'DELETED': return 'üóëÔ∏è';
                default: return 'üìã';
            }
        }
        
        function testActivity() {
            fetch('http://localhost:8083/api/v1/activities/test')
                .then(response => response.text())
                .then(data => console.log('Test activity triggered:', data))
                .catch(error => console.error('Error:', error));
        }
        
        function clearActivities() {
            document.getElementById('activities').innerHTML = '';
        }
        
        // Connect when page loads
        window.onload = function() {
            connect();
        };
    </script>
</body>
</html>